{% extends "base.html" %}
{% block title %}Le mie donazioni{% endblock %}
{% block le_mie_raccolte_active %}active{% endblock %}
{% block page_name%}Il mio profilo{%endblock%}

<!--Nella pagina l'utente può visualizzare tutte le sue raccolte in corso o terminate ed eventualmente
aggiungerle o rimuoverle. Viene visualizzato anche il totale raccolta dalle proprie donazioni
che è consultabile nella colonna "portafoglio" nella tabella utente -->
<!--Vengono visualizzate anche tutte le donazioni effettuate-->

{% block content %}


<h2>Il mio portafoglio: {{ current_user.portafoglio }} € raccolti.</h2>

<main class="col-lg-9 col-md-12">
    <div class="container">
        <div class="row">
            <div class="col-3">
                <!-- 3 colonne lasciate vuote a sinistra, si potrebbe aggiungere una sidebar con
                i dati dell'utente che ha eseguito l'accesso-->
            </div>

            <div class="col-9">
                <!--Le raccolte in corso sono modificabili attraverso un apposito pulsante
                oppure cancellabili attraverso un altro pulsante ancora-->
                <h2>Le tue raccolte in corso:</h2>
                {% for raccolta in raccolte_utente %}
                    {% if raccolta.status == "attiva" %}
                        <div class="card mb-3" style="max-width: 540px;">
                            <div class="row g-0">
                                {% if raccolta.immagine %}
                                    <div class="col-md-4">
                                        <img src="{{ url_for('static', filename=raccolta.immagine) }}" class="img-fluid rounded-start" alt="Questa è l'immagine della raccolta {{ raccolta.nome_raccolta | e }}">
                                    </div>
                                {% endif %}
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            {{ raccolta.nome_raccolta | e }}
                                            - {% if raccolta.tipo_raccolta == 'lampo' %} Lampo
                                            {% else %} Normale
                                            {% endif %}
                                        </h5>
                                        <p class="card-text">{{ raccolta.descrizione }}</p>
                                        <p class="card-text">Totale raccolto: {{ raccolta.cifra_attuale }}€ / {{ raccolta.cifra_da_raggiungere }} €</p>
                                        {% if raccolta.tipo_raccolta == 'lampo' %}
                                            <p class="card-text"><small class="text-muted">Raccolta creata alle ore: {{ raccolta.data_creazione.split(' ')[1] }}</small></p>
                                            <p class="card-text"><small class="text-muted">Termina alle ore: {{ raccolta.data_termine.split(' ')[1] }}</small></p>
                                        {% else %}
                                            <p class="card-text"><small class="text-muted">Raccolta creata il: {{ raccolta.data_creazione }}</small></p>
                                            <p class="card-text"><small class="text-muted">Termina il: {{ raccolta.data_termine }}</small></p>
                                        {% endif %}

<!-- Pulsante Modifica, tutti i campi sono pre-popolati con i dati già esistenti relativi alla raccolta-->
<button type="button"  data-bs-toggle="modal" data-bs-target="#createModal">
    Modifica
  </button>
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Modifica la raccolta fondi "{{raccolta.nome_raccolta}}"</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{url_for('modifica_raccolta', id_raccolta=raccolta.id_raccolta) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                <div class="mb-3">
                    <label for="nuovotitoloInput" class="form-label">Nuovo titolo</label>
                    <input type="text" class="form-control" id="nuovotitoloInput" name="nuovo_titolo_raccolta" value="{{ raccolta.nome_raccolta }}" required>
                </div>
                <div class="mb-3">
                    <label for="nuovodescrizioneTextArea" class="form-label">Nuova descrizione</label>
                    <textarea class="form-control" id="nuovodescrizioneTextArea" name="nuova_descrizione" rows="3"
                    placeholder="Inserisci una nuova descrizione per la tua raccolta fondi" required minlength="30">{{ raccolta.descrizione }}</textarea>
                </div>
                <div class="mb-3">
                    <label for="nuovoimageFile" class="form-label">Aggiungi una nuova immagine, se vuoi</label>
                    <input class="form-control" name="nuova_immagine_raccolta" type="file" id="nuovoimageFile" value="{{ raccolta.immagine }}">
                </div>
                <div class="input-group mb-3">
                    <label for="nuovo_cifra_da_raggiungereInput" class="form-label mb-2">Nuova cifra da raggiungere</label>
                    <span class="input-group-text">€</span>
                    <input type="text" class="form-control" id="nuovo_cifra_da_raggiungereInput" name="nuova_cifra_da_raggiungere" aria-label="Cifra da raggiungere" value="{{ raccolta.cifra_da_raggiungere }}" required>
                </div>
                <div class="input-group mb-3">
                    <label for="nuovo_importo_minimoInput" class="form-label mb-2">Nuovo importo minimo</label>
                    <span class="input-group-text">€</span>
                    <input type="text" class="form-control" id="nuovo_importo_minimoInput" name="nuovo_importo_minimo" aria-label="Importo minimo" value="{{ raccolta.importo_minimo}}" required>
                </div>
                <div class="input-group mb-3">
                    <label for="nuovo_importo_massimoInput" class="form-label mb-2">Nuovo importo massimo</label>
                    <span class="input-group-text">€</span>
                    <input type="text" class="form-control" id="nuovo_importo_massimoInput" name="nuovo_importo_massimo" aria-label="Importo massimo" value="{{ raccolta.importo_massimo }}" required>
                </div>
                <input type="number" name="id_raccolta" value="{{ raccolta.id_raccolta }}" hidden>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button type="submit" class="btn btn-primary">Modifica</button>
                </div>
            </form>
            </div>
        </div>
    </div>                  

                                        
<!-- Pulsante Cancella -->
<form action="{{ url_for('cancella_raccolta', id_raccolta=raccolta.id_raccolta) }}" method="POST" onsubmit="return confirm('Sei sicuro di voler cancellare questa raccolta?');">
    <input type="hidden" name="id_raccolta" value="{{ raccolta.id_raccolta }}">
    <button type="submit" class="btn btn-danger">Cancella</button>
</form>

                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}
<!--Qui finiscono le raccolte attive (che si devono poter modificare)
Iniziano quelle terminate e non più modificabili-->

                <h2>Le tue raccolte terminate:</h2>
                {% for raccolta in raccolte_utente %}
                    {% if raccolta.status == "terminata" %}
                        <div class="card mb-3" style="max-width: 540px;">
                            <div class="row g-0">
                                {% if raccolta.immagine %}
                                    <div class="col-md-4">
                                        <img src="{{ url_for('static', filename=raccolta.immagine) }}" class="img-fluid rounded-start" alt="Questa è l'immagine della raccolta {{ raccolta.nome_raccolta | e }}">
                                    </div>
                                {% endif %}
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            {{ raccolta.nome_raccolta | e }}
                                            - {% if raccolta.tipo_raccolta == 'lampo' %} Lampo
                                            {% else %} Normale
                                            {% endif %}
                                        </h5>
                                        <p class="card-text">{{ raccolta.descrizione }}</p>
                                        <p class="card-text">Totale raccolto: {{ raccolta.cifra_attuale }}€ / {{ raccolta.cifra_da_raggiungere }} €</p>
                                        {% if raccolta.cifra_attuale >= raccolta.cifra_da_raggiungere %}
                                        <h5 class="raccolte_terminate_successo">Raccolta andata a buon fine</h5>
                                         {%  else %}
                                        <h5 class="raccolte_terminate_fallita">La raccolta non ha raggiunto l'obiettivo</h5>
                                        {% endif %}
                                        {% if raccolta.tipo_raccolta == 'lampo' %}
                                            <p class="card-text"><small class="text-muted">Raccolta creata alle ore: {{ raccolta.data_creazione.split(' ')[1] }}</small></p>
                                            <p class="card-text"><small class="text-muted">Termina alle ore: {{ raccolta.data_termine.split(' ')[1] }}</small></p>
                                        {% else %}
                                            <p class="card-text"><small class="text-muted">Raccolta creata il: {{ raccolta.data_creazione }}</small></p>
                                            <p class="card-text"><small class="text-muted">Termina il: {{ raccolta.data_termine }}</small></p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                
            </div>
        </div>
    </div>
</main>

{% endblock %}
